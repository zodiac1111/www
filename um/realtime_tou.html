<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
		<title>实时电度量</title>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<link rel="stylesheet" href="/style/normal_ws.css" type="text/css" />
		<link rel="stylesheet" href="/style/sys.css" type="text/css" />
		<link rel="stylesheet" href="/style/table.css" type="text/css" />
		<link rel="stylesheet" href="/style/menuExpandable3.css"  type="text/css" />
		<script src="/js/wwyfunc.js" type="text/javascript"></script>
		<!-- 基于jquery的日期时间控件所需要的文件 --开始-->
		<link rel="stylesheet" media="all" type="text/css" href="/style/jquery-ui.css" />
		<script type="text/javascript" src="/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="/js/jquery-ui.min.js"></script>
		<script type="text/javascript" src="/js/jquery-ui.min-zh-CN.js"></script>
		<script type="text/javascript" src="/js/jquery-ui-sliderAccess.js"></script>
		<script type="text/javascript" src="/js/reset.js"></script>
		<!-- 基于jquery的日期时间控件所需要的文件 --结束-->
		<link type="text/css" href="/style/jquery.dataTables.css" rel="stylesheet"  />
		<link type="text/css" href="/style/jquery.dataTables_themeroller.css" rel="stylesheet"  />
		<script type="text/javascript" src="/js/jquery.dataTables.js"></script>
		<script type="text/javascript">
			var conf = true;
			$(document).ready(function() {
				///主过程
				var obtnRefresh = $("#btnManualRefresh");
				//$("#realtime_dat").hide();
				obtnRefresh.click(function() {
					refresh();
				});
				setMtr();
				setItem($("#select_item"));
				setItemFirst($("#select_item_first"));
				$("#btnSelectItem").click(function() {
					if (conf == true) {
						conf = false;
						//$("#tbl_realtime_dat_select").hide();
						//$("#realtime_dat").show();
					} else {
						conf = true;
						//$("#realtime_dat").hide();
						//$("#tbl_realtime_dat_select").show();
					}
				});
				var btnAutoRefresh = $("#btnAutoRefresh");
				var btnStopRefresh = $("#btnStopRefresh");
				var refreshIntervalId ;//时钟id
				btnAutoRefresh.click(function() {
					btnAutoRefresh.hide();
					$("#btnManualRefresh").attr("disabled", "disabled");
					var t = parseInt($("#autoRefresh_interval").val()) || 0;
					if (t < 5) {
						t = 5;
						$("#autoRefresh_interval").val("1");
					}
					refreshIntervalId =setInterval(refresh, t * 1000);
					btnStopRefresh.show();
				});
				btnStopRefresh.click(function() {
					btnStopRefresh.hide();
					$("#btnManualRefresh").removeAttr("disabled");
					clearInterval(refreshIntervalId);
					btnAutoRefresh.show();
				});
				init();
			});
			//根据系统参数设置表个数
			function setMtr() {
				var mtrNumber = 0;
				var str = "";
				$.ajax({
					type : "post",
					//同步方式,必须等到获得了表数才进行下一步
					async : false,
					url : "/goform/sysparam",
					contentType : "application/x-www-form-urlencoded; charset=utf-8",
					dataType : "text",
					data : "action=get",
					success : function(data, textStatus) {//成功
						var oSysPara = eval("(" + data + ")");
						mtrNumber = parseInt(oSysPara.meter_num);
					},
					error : function() {//失败
						alert("服务器通讯错误");
					}
				});
				var newline = 10;
				//每几个换一行
				for ( i = 0; i < mtrNumber; i++) {
					name = "mtrNo" + i;
					str += "<input type=checkbox name=" + name + " id=\"" + name + "\" />" + "<label for=" + name + ">" + "表" + i + "</label>";
					//如果有20个,则分两行,第二行末尾不增加换行
					if ((i % newline == newline - 1) && (i < (mtrNumber - 1))) {
						str += "<br>"
					}
				}
				$("#mtr_selected").html("");
				$("#mtr_selected").html(str);
			}

			function refresh() {
				var itemArray = "";
				var mtrArray = ""
				var aItem = $("[id^='touItem']");
				var aMtr = $("[id^='mtrNo']");
				var len = aItem.length;
				var lenMtr = aMtr.length;
				//构造表号和项目字串 如 001100 1表示有效 项目/表
				for ( i = 0; i < len; i++) {
					itemArray += aItem[i].checked ? "1" : 0;
				}
				for ( i = 0; i < lenMtr; i++) {
					mtrArray += aMtr[i].checked ? "1" : "0";
				}
				if ($("[id^='touItem']:checked:enabled").length <= 0) {
					alert("至少选择一个监视项目");
					return;
				}
				if ($("[id^='mtrNo']:checked:enabled").length  <= 0) {
					alert("至少选择一个表");
					return;
				}
				//时间
				$.post('/goform/srv_time', "action=get", function(result) {
					var oTime = eval("(" + result + ")");
					var timeZoneMs = 8 * 60 * 60;
					srvTimestarmp = Number(oTime.timestamp - timeZoneMs);
					fillDataTimestarmp(srvTimestarmp);
				});
				//开始通讯
				$.ajax({
					type : "post",
					url : "/goform/realtime_tou",
					contentType : "application/x-www-form-urlencoded; charset=utf-8",
					dataType : "text",
					data : "action=get" + "&itemArray=" + itemArray + "&mtrArray=" + mtrArray,
					success : function(result, textStatus) {
						var oTou = eval("(" + result + ")");
						fillDataHead($("#dateHead"), itemArray);
						fillData($("#touData"), oTou, mtrArray);
					},
					error : function() {//失败
						alert("服务器通讯错误");
					}
				});
			}

			//填写时间戳(标识终端实时数据的时间)
			function fillDataTimestarmp(srvTimestarmp) {
				var now = new Date(srvTimestarmp * 1000);
				var str = "数据时刻:";
				str+=$.datepicker.formatDate('yy-mm-dd ',now);
				str+=now.getHours()<10?"0":"";
				str+=now.getHours();
				str+=":"+(now.getMinutes()<10?"0":"")+now.getHours()
				str+=":"+(now.getSeconds()<10?"0":"")+now.getSeconds();
					$("#timestamp").html(str);
			}

			//生成数据表头
			function fillDataHead(oHead, itemArray) {
				oHead.html("");
				str = "";
				len = itemArray.length;
				str += "<td>表号</td>";
				var head = false;
				for ( i = 0; i < len; i++) {
					if (i % 5 == 0) {//每种数据开始使用全名称
						head = true;
					}
					if (itemArray[i] == "1") {
						str += "<td>";
						switch (parseInt(i/5)) {
							case 0:
								str += head ? "正向有功" : "";
								head = false;
								break;
							case 1:
								str += head ? "反向有功" : "";
								head = false;
								break;
							case 2:
								str += head ? "正向无功" : "";
								head = false;
								break;
							case 3:
								str += head ? "反向无功" : "";
								head = false;
								break;
							case 4:
								str += head ? "一象限无功" : "";
								head = false;
								break;
							case 5:
								str += head ? "二象限无功" : "";
								head = false;
								break;
							case 6:
								str += head ? "二象限无功" : "";
								head = false;
								break;
							case 7:
								str += head ? "二象限无功" : "";
								head = false;
								break;
						}
						switch (i%5) {
							case 0:
								str += "总";
								break;
							case 1:
								str += "尖";
								break;
							case 2:
								str += "峰";
								break;
							case 3:
								str += "平";
								break;
							case 4:
								str += "谷";
								break;
						}
						str += "</td>";
					}
				}
				oHead.html(str);
			}

			//在mtrArray 中找到第 i 个 等于"1"的字符,返回这个字符的index
			function fillMtrNumber(i, mtrArray) {
				var num = 0;
				for ( j = 0; j < mtrArray.length; j++) {
					if (mtrArray[j] == 1) {
						if (num == i) {
							break;
						}
						num++;
					}
				}
				str += "<td>" + j + "</td>";
				return str
			}

			//将数据填充到表格中
			function fillData(oTable, oTou, mtrArray) {
				oTable.html("");
				str = "";
				mtrnum = oTou.length;
				for ( i = 0; i < mtrnum; i++) {

					str += "<tr>";
					fillMtrNumber(i, mtrArray)
					for ( j = 0; j < oTou[i].length; j++) {
						var iv=(oTou[i][j][0]==1)?"iv":"";
						str += "<td class="+iv+">" + oTou[i][j][0] + "</td>";
					}
					str += "</tr>";
				}
				oTable.html(str);
				return;
			}

			//设定初始(默认)状态.
			function init() {
				set_val(0, true);
				set_val(5, true);
				set_val(10, true);
				set_val(15, true);
				$("#btnStopRefresh").hide();
				$("#mtrNo0")[0].checked=true;
			}

			//设置高一级的项目(大的项目)
			function setItemFirst(obj) {
				obj.html("");
				var str = "";
				for ( i = 0; i < 8; i++) {
					var name = "all_tou";
					name += i;
					str += "<td colspan=\"5\">" + "<input type=\"checkbox\" name=" + name + " value=\"" + "0" + "\" id=\"" + name + "\" onclick= \"check_click(" + i + ");\"" + " />" + "<label for=" + name + ">";
					switch(i) {
						case 0:
							str += "正向有功";
							break;
						case 1:
							str += "反向有功";
							break;
						case 2:
							str += "正向无功";
							break;
						case 3:
							str += "反向无功";
							break;
						case 4:
							str += "第一象限无功";
							break;
						case 5:
							str += "第二象限无功";
							break;
						case 6:
							str += "第三象限无功";
							break;
						case 7:
							str += "第四象限无功";
							break;
					}
					str += "</label></td>";
				}
				obj.append(str);
			}

			function check_click(i) {
				for ( ind = 0; ind < 5; ind++) {
					set_val(i * 5 + ind, $("#all_tou"+i)[0].checked);
				}
			}

			function set_val(i, bchecked) {
				$("#touItem" + i)[0].checked = bchecked;
				$("#touItem" + i)[0].value = bchecked ? "1" : "0";
			}

			function change_val(i) {
				bchecked = $("#touItem" + i)[0].checked;
				$("#touItem" + i)[0].checked = bchecked;
				$("#touItem" + i)[0].value = bchecked ? "1" : "0";
			}

			function setItem(obj) {
				obj.html("");
				var str = "";
				for ( i = 0; i < 40; i++) {
					var name = "touItem" + i;
					str += "<td><input type=checkbox name=" + name + " value=" + "0" + " onclick= \"change_val(" + i + ");\"" + " id=" + name + " /><br><label for=" + name + ">";
					switch(i % 5) {
						case 0:
							str += "总";
							break;
						case 1:
							str += "尖";
							break;
						case 2:
							str += "峰";
							break;
						case 3:
							str += "平";
							break;
						case 4:
							str += "谷";
							break;
					}
					str += "</label></td>";
				}
				obj.append(str);
			}
		</script>
	</head>
	<body>
		<table class="sioplanTable"  id="tbl_realtime_tou" border="1" cellspacing="1" cellpadding="1">
			<tr>
				<td id="mtr_selected" colspan="4">所有表计</td>
			</tr>
			<tr>
				<td>自动刷新间隔:
				<input id="autoRefresh_interval" value="5"/>
				秒
				<button id="btnAutoRefresh" class="run">
					启动
				</button>
				<button id="btnStopRefresh" class="stop">
					停止
				</button></td>
				<td>
				<button id="btnManualRefresh" class="simple_button">
					手动刷新
				</button></td>
				<td>
				<button id="btnSelectItem" class="btnSet">
					设置
				</button></td>
			</tr>
		</table>
		<!-- 查询项目选择 -->
		<form id="form_realtime_dat_select">
			<table class="sioplanTable"  id="tbl_realtime_dat_select" border="1" cellspacing="1" cellpadding="1">
				<thead>
					<tr>
						<td colspan="40">电度量</td>
					</tr>
					<tr id="select_item_first">
						<td colspan="40">总项目</td>
					</tr>
					<tr id="select_item">
						<td colspan="40">分时项目</td>
					</tr>
				</thead>
			</table>
		</form>
		<!-- 数据显示 -->
		<table class="sioplanTable"  id="realtime_dat" border="1" cellspacing="1" cellpadding="1">
			<thead>
				<tr>
					<td colspan="40">电度量 (<span id="timestamp">时刻</span>)</td>
				</tr>
				<tr id="dateHead">
					<td colspan="2">项目名称</td>
				</tr>
			</thead>
			<tbody id="touData">
				<td colspan="2">实时数据</td>
			</tbody>
		</table>
	</body>
</html>
