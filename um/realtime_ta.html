<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>实时瞬时量</title>
		<link rel="stylesheet" href="/style/normal_ws.css" type="text/css"/>
		<link rel="stylesheet" href="/style/sys.css" type="text/css"/>
		<link rel="stylesheet" href="/style/table.css" type="text/css"/>
		<link rel="stylesheet" href="/style/menuExpandable3.css" type="text/css"/>
		<script src="/js/wwyfunc.js" type="text/javascript"></script>
		<!-- 基于jquery的日期时间控件所需要的文件 --开始-->
		<link rel="stylesheet" media="all" type="text/css" href="/style/jquery-ui.css"/>
		<script type="text/javascript" src="/js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="/js/jquery-ui.min.js"></script>
		<script type="text/javascript" src="/js/jquery-ui.min-zh-CN.js"></script>
		<script type="text/javascript" src="/js/jquery-ui-sliderAccess.js"></script>
		<script type="text/javascript" src="/js/reset.js"></script>
		<!-- 基于jquery的日期时间控件所需要的文件 --结束-->
		<link type="text/css" href="/style/jquery.dataTables.css" rel="stylesheet"/>
		<link type="text/css" href="/style/jquery.dataTables_themeroller.css" rel="stylesheet"/>
		<script type="text/javascript" src="/js/jquery.dataTables.min.js"></script>
		<script type="text/javascript">
			$.extend($.fn.dataTable.defaults, {//设置表格属性
				"bInfo" : false, //显示一共几条这种信息
				"bFilter" : false, //不要搜索
				"bSort" : false, //不要排序
				//"sScrollY" : "320px", //固定高度
				"bPaginate" : false, //不显示分页
				//"bScrollCollapse" : true, //显示滚动条
				"bRetrieve" : true,
				"bJQueryUI" : true,
				"bDestroy" : true
				//"bAutoWidth" : true
			});
			//var ie = !-[1,]; //ie则返回true,否则返回false
			var timeZoneMs = 8 * 60 * 60;
			// 当前显示类型.显示参数还是显示数据.开始时显示参数设置
			var isShowSet = true;
			var ShowData = true;
			//时钟id
			var refreshIntervalId;
			$(document).ready(function() {
				///主过程
				var btnAutoRefresh = $("#btnAutoRefresh");
				var btnStopRefresh = $("#btnStopRefresh");
				var obtnRefresh = $("#btnManualRefresh");
				//界面的生成
				setMtr();
				setItem($("#select_item"));
				setItemFirst($("#select_item_first"));
				//然后才是事件的绑定
				obtnRefresh.click(function() {
					refresh();
				});
				$("#btnSelectItem").click(function() {
					if (isShowSet) {
						$(".conf_talbe").hide();
					} else {
						$(".conf_talbe").show();
					}
					isShowSet = !isShowSet;
				});

				btnAutoRefresh.click(function() {
					btnAutoRefresh.hide();
					$("#btnManualRefresh").attr("disabled", "disabled");
					var t = parseInt($("#autoRefresh_interval").val()) || 0;
					if (t < 5) {
						t = 5;
						$("#autoRefresh_interval").val("5");
					}
					//点击开始就立刻刷新一次,之后按照定时器刷新.
					refresh();
					refreshIntervalId = setInterval(refresh, t * 1000);
					btnStopRefresh.show();
				});
				btnStopRefresh.click(function() {
					btnStopRefresh.hide();
					$("#btnManualRefresh").removeAttr("disabled");
					clearInterval(refreshIntervalId);
					btnAutoRefresh.show();
				});
				init();
			});

			//根据系统参数设置表个数
			function setMtr() {
				var mtrNumber = 0;
				var str = "";
				$.ajax({
					type : "post",
					//同步方式,必须等到获得了表数才进行下一步
					async : false,
					url : "/goform/sysparam",
					contentType : "application/x-www-form-urlencoded; charset=utf-8",
					dataType : "text",
					data : "action=get",
					success : function(data, textStatus) {//成功
						var oSysPara = eval("(" + data + ")");
						mtrNumber = parseInt(oSysPara.meter_num);
					},
					error : function() {//失败
						alert("服务器通讯错误,获取表计数目失败");
					}
				});
				//每几个换一行
				var newline = 20;
				for ( i = 0; i < mtrNumber; i++) {
					var name = "mtrNo" + i;
					//width: 44px; str += "<span><input type=checkbox name=" + name + " id=\"" + name
					// + "\" />" + "<label for=" + name + ">" + "表" + i + "</label><span>";
					str += "<span style=\"display: inline-block; width: 25px;\">";
					str += "<label>";
					str += "<input class=\"meterNumber\" type=checkbox name=" + name;
					str += " id=\"" + name + "\" /><br>";
					str += "表" + i + "</label></span>";
					//如果有20个,则分两行,第二行末尾不增加换行
					if ((i % newline == newline - 1) && (i < (mtrNumber - 1))) {
						str += "<br>";
					}
				}
				$("#mtr_selected").html("");
				$("#mtr_selected").html(str);
				$(function() {
					$("#slider-range").slider({
						range : true,
						min : 0,
						max : mtrNumber,
						values : [0, 1],
						slide : function(event, ui) {
							for ( i = 0; i < mtrNumber; i++) {
								$("#mtrNo" + i)[0].checked = false;
							}
							for ( i = ui.values[0]; i < ui.values[1]; i++) {
								$("#mtrNo" + i)[0].checked = true;
							}
						}
					});
				});
			}

			//刷新函数,手动刷新
			function refresh() {
				if (ShowData) {
					$("#realtime_dat").show();
					ShowData = false;
				}
				var itemArray = "";
				var mtrArray = ""
				var aItem = $("[id^='touItem']");
				var aMtr = $("[id^='mtrNo']");
				var len = aItem.length;
				var lenMtr = aMtr.length;
				//构造表号和项目字串 如 001100 1表示有效 项目/表
				for ( i = 0; i < len; i++) {
					itemArray += aItem[i].checked ? "1" : 0;
				}
				for ( i = 0; i < lenMtr; i++) {
					mtrArray += aMtr[i].checked ? "1" : "0";
				}
				if ($(".subcategory:checked:enabled").length <= 0) {
					alert("至少选择一个监视项目");
					return;
				}
				if ($(".meterNumber:checked:enabled").length <= 0) {
					alert("至少选择一个表");
					return;
				}
				$("#btnManualRefresh").attr("disabled", "disabled");
				//时间
				$.ajax({
					type : "post",
					url : "/goform/srv_time",
					contentType : "application/x-www-form-urlencoded; charset=utf-8",
					dataType : "text",
					data : "action=get",
					success : function(result, textStatus) {
						var oTime = eval("(" + result + ")");
						//转化成为标准时间（减去时区偏移即可），
						srvTimestarmp = Number(oTime.timestamp - timeZoneMs);
						fillDataTimestarmp(srvTimestarmp);
					},
					error : function() {//失败
						alert("服务器通讯错误,获取时间失败");
					}
				});
				//开始通讯
				$.ajax({
					type : "post",
					url : "/goform/realtime_tou",
					contentType : "application/x-www-form-urlencoded; charset=utf-8",
					dataType : "text",
					data : "action=get" + "&itemArray=" + itemArray + "&mtrArray=" + mtrArray,
					success : function(result, textStatus) {
						var oTou = eval("(" + result + ")");
						fillDataHead($("#dateHead"), oTou.item_selected);
						fillData($("#touData"), oTou.mtr, oTou.mtr_selected);
						//oTable.fnDestroy(false);
						$('#realtime_dat').dataTable();
					},
					error : function() {//失败
						alert("服务器通讯错误,获取数据失败");
					},
					//完成(发生在失败或成功之后)
					complete : function(XMLHttpRequest, textStatus) {
						$("#btnManualRefresh").removeAttr("disabled");
					}
				});

			}

			//填写时间戳(标识终端实时数据的时间)
			function fillDataTimestarmp(srvTimestarmp) {
				var str = "数据时刻:";
				str += timestarmpToString(srvTimestarmp);
				$("#timestamp").html(str);
			}

			//将时间戳换算成为完整的日期时刻格式,
			//输入 srvTimestarmp 为数值型整形 时间戳(标准时间),到现在的秒数(Unix格式)
			//返回形如 2013-02-20 14:45:09 的字符串
			function timestarmpToString(UnixUtcTimestarmp) {
				if (UnixUtcTimestarmp <= 0) {//时区的关系(可能要扩展到24个小时)
					return "---------- --:--:--";
				}
				var now = new Date(UnixUtcTimestarmp * 1000);
				//js中是毫秒
				var str = $.datepicker.formatDate('yy-mm-dd ', now);
				str += now.getHours() < 10 ? "0" : "";
				str += now.getHours();
				str += ":" + (now.getMinutes() < 10 ? "0" : "") + now.getMinutes()
				str += ":" + (now.getSeconds() < 10 ? "0" : "") + now.getSeconds();
				return str;
			}

			//生成数据表头
			function fillDataHead(oHead, itemArray) {
				oHead.html("");
				str = "";
				len = itemArray.length;
				str += "<th>表号</th>";
				str += "<th>抄表时刻</th>";
				var head = false;
				for ( i = 0; i < len; i++) {
					if (i % 5 == 0) {//每种数据开始使用全名称
						head = true;
					}
					//ie 不能使用 string[i]来索引char,只能使用charAt
					if (itemArray.charAt(i) == "1") {
						str += "<th>";
						switch (parseInt(i/4)) {
							case 0:
								str += head ? "电压<br>" : "<br>";
								head = false;
								break;
							case 1:
								str += head ? "电流<br>" : "<br>";
								head = false;
								break;
							case 2:
								str += head ? "有功功率<br>" : "<br>";
								head = false;
								break;
							case 3:
								str += head ? "无功功率<br>" : "<br>";
								head = false;
								break;
							case 4:
								str += head ? "功率因数<br>" : "<br>";
								head = false;
								break;
							case 5:
								str += head ? "频率<br>" : "<br>";
								head = false;
								break;
						}
						switch (i%4) {
							case 0:
								str += "总";
								break;
							case 1:
								str += "A";
								break;
							case 2:
								str += "B";
								break;
							case 3:
								str += "C";
								break;
						}
						str += "</th>";
					}
				}
				oHead.html(str);
			}

			//在mtrArray 中找到第 i 个 等于"1"的字符,返回这个字符的index
			function fillMtrNumber(i, mtrArray) {
				var num = 0;
				for ( j = 0; j < mtrArray.length; j++) {
					if (mtrArray.charAt(j) == "1") {//tian sha de ie!
						if (num == i) {
							break;
						}
						num++;
					}
				}
				return "<td>" + j + "</td>";
			}

			//填写抄表时刻表格
			function fillMtrReadTime(UnixUTCTimestarmp) {
				return "<td>" + timestarmpToString(UnixUTCTimestarmp - timeZoneMs) + "</td>";
			}

			//将数据填充到表格中,aMtr:表计对象数组
			function fillData(oTable, aMtr, mtrArray) {
				str = "";
				mtrnum = aMtr.length;
				for ( i = 0; i < mtrnum; i++) {
					str += "<tr>";
					str += fillMtrNumber(i, mtrArray)
					str += fillMtrReadTime(parseInt(aMtr[i].Meter_ReadTime));
					for ( j = 0; j < aMtr[i].it.length; j++) {
						var iv = (aMtr[i].it[j][1] == "1") ? "valid " : "iv";
						// *有效*标识
						str += "<td class=" + iv + ">" + aMtr[i].it[j][0] + "</td>";
					}
					str += "</tr>";
				}
				oTable.html("");
				oTable.html(str);
				return;
			}

			//设定初始(默认)状态.
			function init() {
				set_val(0, true);
				set_val(5, true);
				set_val(10, true);
				set_val(15, true);
				$("#btnStopRefresh").hide();
				$("#mtrNo0")[0].checked = true;
				//$('#realtime_dat').dataTable();
				$("#realtime_dat").hide();
				$("input[id^='all_']").click(function(event) {
					var id = event.target.id.substr(4);
					var bcheck = event.target.checked;
					var aChild = $("input[id^='" + id + "_']");
					for ( i = 0; i < aChild.length; i++) {
						aChild[i].checked = bcheck;
					}
				});
				$.each($("input[id^='item_v]"), function(index, e) {
					e.checked = true;
				})
				$.each($("input[id^='item_i]"), function(index, e) {
					e.checked = true;
				})
				$("#item_p_0").checked = true;
			}

			//填写一个配置表格的大项目单元格,名称,中文名称,包含多少子项目
			function setItemFirstTableData(name, name_cn, items) {
				var str = "";
				str += "<td colspan=\"" + items + "\">";
				str += "<label>";
				str += "<input class=\"main_category\" type=\"checkbox\" name=" + name + "\" id=\"" + name + "\" />";
				str += name_cn + "</label>";
				str += "</td>";
				return str;
			}

			//设置高一级的项目(大的项目) 电压 电流 有功功率 无功功率 功率因数 频率=6大项
			function setItemFirst(obj) {
				var str = "";
				str += setItemFirstTableData("all_item_v", "三相电压", 3);
				str += setItemFirstTableData("all_item_i", "三相电流", 3);
				str += setItemFirstTableData("all_item_p", "有功功率", 4);
				str += setItemFirstTableData("all_item_q", "无功功率", 4);
				str += setItemFirstTableData("all_item_pf", "功率因数", 4);
				str += setItemFirstTableData("all_item_f", "频率", 1);
				obj.html("");
				obj.html(str);
			}

			//单击上层选中下层的5个分时电量
			function check_click(i) {
				var bchecked = $("#all_tou"+i)[0].checked;
				for ( ind = 0; ind < 5; ind++) {
					set_val(i * 5 + ind, bchecked);
				}
			}

			//设置checkbox选中/不选中
			function set_val(i, bchecked) {
				//$("#touItem" + i)[0].checked = bchecked;
				//$("#touItem" + i)[0].value = bchecked ? "1" : "0";
			}

			//选中/不选中中切换,同时更新value
			function change_val(i) {
				//bchecked = $("#touItem" + i)[0].checked;
				//$("#touItem" + i)[0].checked = bchecked;
				//$("#touItem" + i)[0].value = bchecked ? "1" : "0";
			}

			function setItemTableDate(name, index, name_cn) {
				str = "";
				str += "<td>";
				str += "<label>";
				str += "<input class=\"subcategory\" type=\"checkbox\" name=" + name + "_" + index;
				str += "\" id=\"" + name + "_" + index + "\" />"
				str += name_cn + "</label>";
				str += "</td>";
				return str;
			}

			function setItem(obj) {
				var str = "";
				str += setItemTableDate("item_v", 0, "A");
				str += setItemTableDate("item_v", 1, "B");
				str += setItemTableDate("item_v", 2, "C");
				str += setItemTableDate("item_i", 0, "A");
				str += setItemTableDate("item_i", 1, "B");
				str += setItemTableDate("item_i", 2, "C");
				str += setItemTableDate("item_p", 0, "总");
				str += setItemTableDate("item_p", 1, "A");
				str += setItemTableDate("item_p", 2, "B");
				str += setItemTableDate("item_p", 3, "C");
				str += setItemTableDate("item_q", 0, "总");
				str += setItemTableDate("item_q", 1, "A");
				str += setItemTableDate("item_q", 2, "B");
				str += setItemTableDate("item_q", 3, "C");
				str += setItemTableDate("item_pf", 0, "总");
				str += setItemTableDate("item_pf", 1, "A");
				str += setItemTableDate("item_pf", 2, "B");
				str += setItemTableDate("item_pf", 3, "C");
				str += setItemTableDate("item_f", 0, "频率");
				obj.html("");
				obj.html(str);
			}
		</script>
	</head>
	<body>
		<!-- 显示/隐藏按钮 -->
		<div style="position:fixed;right:0px;top:0px;z-index:99;">
			<button id="btnSelectItem" class="btnSet" >
				Menu
			</button>
		</div>
		<!-- 查询项目选择 -->
		<table class="sioplanTable conf_table" style="width:100%;"  id="tbl_realtime_dat_select" border="1" cellspacing="1" cellpadding="1">
			<tr>
				<th colspan="1" style="width: 5%;">表号</th>
				<td colspan="1" style="width: 75%;" id="mtr_selected_bar"><div id="slider-range"></div></td>
				<td colspan="5" style="width: 12.5%;">自动刷新间隔
				<input id="autoRefresh_interval" value="5"/>
				秒</td>
				<td colspan="3"style="width: 7.5%;">_</td>
			</tr>
			<tr>
				<td colspan="2"style="width: 80%;" id="mtr_selected" style="text-align:left;">[表号列表]</td>
				<td colspan="4" style="width: 10%;"><span>
					<button id="btnAutoRefresh" class="run">
						自动刷新
					</button>
					<br>
					<button id="btnStopRefresh" class="stop">
						停止刷新
					</button></span></td>
				<td colspan="4" style="width: 10%;">
				<button id="btnManualRefresh" class="simple_button">
					手动刷新
				</button></td>
			</tr>
		</table>
		<table class="sioplanTable conf_table" style="width:100%;" border="1" cellspacing="1" cellpadding="1">
			<tr>
				<th colspan="99">电度量</th>
			</tr>
			<tr id="select_item_first">
				<td colspan="">总项目</td>
			</tr>
			<tr id="select_item">
				<td colspan="">分时项目</td>
			</tr>
		</table>
		<br>
		<!-- 数据显示 -->
		<table class="realtimeTouTable" style="width:100%;" id="realtime_dat" border="1" cellspacing="1" cellpadding="1">
			<thead>
				<tr>
					<th colspan="42">瞬时量 (<span id="timestamp">查询时刻</span>)</th>
				</tr>
				<tr id="dateHead">
					<th colspan="42">项目名称</th>
				</tr>
			</thead>
			<tbody id="touData">
				<td colspan="42">实时数据</td>
			</tbody>
		</table>
	</body>
</html>
